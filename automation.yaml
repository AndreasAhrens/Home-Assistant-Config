####### AUTOMATION #######
# Verisure automation
  - alias: Alarm status changed
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_1
    action:
      - service: notify.notify
        data_template:
          message: >
            Alarm changed from {{ trigger.from_state.state }}
            to {{ trigger.to_state.state }}
            by {{ trigger.to_state.attributes.changed_by }}
      #- service: notify.ios_all_your_base_are_belong_to_us_2
      #  data:
      #    message: "Alarm status changed"
      #    data:
      #      subtitle: 'Alarm changed from {{ trigger.from_state.state }} to {{ trigger.to_state.state }} by {{ trigger.to_state.attributes.changed_by }}'

  #- alias: Alarm status from armed to disarmed
  #  trigger:
  #    - platform: state
  #      entity_id: alarm_control_panel.alarm_1
  #      from: 'armed_away'
  #      to: 'disarmed'
  #      state: 'Welcome home'
  #  action:
  #    - service: notify.ios_all_your_base_are_belong_to_us_2
  #      data:
  #        message: "Alarm disarmed"
  #        data:
  #          push:
  #            sound: "US-EN-Morgan-Freeman-Welcome-Home.wav"


# Turn off lights when alarm is in home mode
  - alias: Alarm status home mode
    trigger:
      - platform: state
        entity_id: alarm_control_panel.alarm_1
        from: 'disarmed'
        to: 'armed_home'
        state: 'Night mode'
    action:
      - service: notify.ios_all_your_base_are_belong_to_us_2
        data:
          message: "Alarm set to home mode"
          data:
            push:
              sound: "US-EN-Morgan-Freeman-Good-Night.wav"
      - service: homeassistant.turn_off
        entity_id:
          - switch.garden_front_door
          - switch.dining_room_aquarium
          - switch.garden_driveway
          - switch.hallway_stairs
          - light.living_room_wall
          - light.tv_bench
          - light.kitchen_top
          - switch.living_room_fan 
      - service: homeassistant.turn_on
        entity_id:
          - light.her_bedside
          - light.his_bedside 
        data:
          brightness: 144

  ####### FRONT DOOR ######
  - alias: Turn on front door light at sunset
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunset
    # Optional time offset. This example is 45 minutes.
        offset: '-00:20:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.garden_front_door

  - alias: Turn off front door light at 23:00
    trigger:
      - platform: time
        after: '23:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.garden_front_door

  - alias: Turn on front door light at 06:30
    trigger:
      - platform: time
        after: '06:30:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.garden_front_door

  - alias: Turn off front door light at sunrise OR 8:30 if not off
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunrise
    # Optional time offset. This example is 45 minutes.
        offset: '+00:20:00'
      - platform: time
        after: '08:30:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.garden_front_door


  ####### AQUARIUM ######
  - alias: Turn on aquarium at 07:00
    trigger:
      - platform: time
        after: '07:00:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.dining_room_aquarium

  - alias: Turn off aquarium at 21:30
    trigger:
      - platform: time
        after: '21:30:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.dining_room_aquarium

  ####### DRIVEWAY ######
  - alias: Turn on DRIVEWAY light at sunset
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunset
    # Optional time offset. This example is 45 minutes.
        offset: '+00:40:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.garden_driveway

  - alias: Turn off DRIVEWAY light at 22:00
    trigger:
      - platform: time
        after: '22:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.garden_driveway

  - alias: Turn on DRIVEWAY light at 07:00
    trigger:
      - platform: time
        after: '07:00:00'
    condition:
      - condition: template
        value_template: '{{ states.sun.sun.attributes.elevation < 0 }}' #only if sun is down
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.garden_driveway

  - alias: Turn off DRIVEWAY light at sunrise
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunrise
    # Optional time offset. This example is 45 minutes.
        offset: '+00:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.garden_driveway

  ####### STAIRS ######
  - alias: Turn on Stairs light at sunset
    trigger:
      - platform: sun
        event: sunset
        offset: '-00:10:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.hallway_stairs

  - alias: Turn off Stairs light at 23:00
    trigger:
      - platform: time
        after: '23:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.hallway_stairs

  - alias: Turn on Stairs light at 06:30
    trigger:
      - platform: time
        after: '06:30:00'
    condition:
      - condition: template
        value_template: '{{ states.sun.sun.attributes.elevation < 0 }}' #only if sun is down
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.hallway_stairs

  - alias: Turn off Stairs light at sunrise
    trigger:
      - platform: sun
        event: sunrise
        offset: '00:01:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.hallway_stairs

  ### Dim the Bedroom bedside lights when getting closer to bed - but never higher than it's already set
  - alias: His Bedside 50% at 22:00
    trigger:
      - platform: time
        after: '22:00:00'
    condition:
      - condition: numeric_state
        entity_id: light.his_bedside
        value_template: '{% if states.light.his_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 144
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.his_bedside
        data:
          brightness: 144
          rgb_color: [243, 179, 80]

  - alias: Her Bedside 50% at 22:00
    trigger:
      - platform: time
        after: '22:00:00'
    condition:
      - condition: numeric_state
        entity_id: light.her_bedside
        value_template: '{% if states.light.her_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 144
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.her_bedside
        data:
          brightness: 144
          

  - alias: His Bedside 25% at 22:30
    trigger:
      - platform: time
        after: '22:30:00'
    condition:
      - condition: numeric_state
        entity_id: light.his_bedside
        value_template: '{% if states.light.his_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 64
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.his_bedside
        data:
          brightness: 64
          rgb_color: [243, 179, 80]

  - alias: Her Bedside 25% at 22:30
    trigger:
      - platform: time
        after: '22:30:00'
    condition:
      - condition: numeric_state
        entity_id: light.her_bedside
        value_template: '{% if states.light.her_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 64
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.her_bedside
        data:
          brightness: 64
          

  - alias: His Bedside 10% at 22:45
    trigger:
      - platform: time
        after: '22:45:00'
    condition:
      - condition: numeric_state
        entity_id: light.his_bedside
        value_template: '{% if states.light.his_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 25
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.his_bedside
        data:
          brightness: 25
          rgb_color: [243, 179, 80]

  - alias: Her Bedside 10% at 22:45
    trigger:
      - platform: time
        after: '22:45:00'
    condition:
      - condition: numeric_state
        entity_id: light.her_bedside
        value_template: '{% if states.light.her_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 25
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.her_bedside
        data:
          brightness: 25
          

  - alias: His Bedside 5% at 23:00
    trigger:
      - platform: time
        after: '23:00:00'
    condition:
      - condition: numeric_state
        entity_id: light.his_bedside
        value_template: '{% if states.light.his_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 12
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.his_bedside
        data:
          brightness: 12
          rgb_color: [243, 179, 80]

  - alias: Her Bedside 5% at 23:00
    trigger:
      - platform: time
        after: '23:00:00'
    condition:
      - condition: numeric_state
        entity_id: light.her_bedside
        value_template: '{% if states.light.her_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 12
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.her_bedside
        data:
          brightness: 12
          

  - alias: His Bedside off at 23:15
    trigger:
      - platform: time
        after: '23:15:00'
    condition:
      - condition: numeric_state
        entity_id: light.his_bedside
        value_template: '{% if states.light.his_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 0
    action:
      - service: homeassistant.turn_off
        entity_id:
          - light.his_bedside

  - alias: Her Bedside off at 23:15
    trigger:
      - platform: time
        after: '23:15:00'
    condition:
      - condition: numeric_state
        entity_id: light.her_bedside
        value_template: '{% if states.light.her_bedside.state == "on"  %}{{ states.light.his_bedside.attributes.brightness }}{% else %}0{% endif %}'
        above: 0
    action:
      - service: homeassistant.turn_off
        entity_id:
          - light.her_bedside

  - alias: Both Bedsides off at 08:00
    trigger:
      - platform: time
        after: '08:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - light.his_bedside
          - light.her_bedside

#### Upper Hallway ##
  - alias: Upstairs hallway 10% at 23:00
    trigger:
      - platform: time
        after: '23:00:00'
    condition:
      - condition: numeric_state
        entity_id: light.upstairs_hallway
        value_template: '{% if states.light.upstairs_hallway.state == "on"  %}{{ states.light.upstairs_hallway.attributes.brightness }}{% else %}0{% endif %}'
        above: 25
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.upstairs_hallway
        data:
          brightness: 25

  - alias: Upstairs hallway 30% at 20:30
    trigger:
      - platform: time
        after: '20:30:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.upstairs_hallway
        data:
          brightness: 50
      - delay: 0:10
      - service: homeassistant.turn_on
        entity_id:
          - light.upstairs_hallway
        data:
          brightness: 45


  - alias: Turn off upper hallway light at sunrise
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunrise
    # Optional time offset. This example is 45 minutes.
        offset: '+00:30:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - light.upstairs_hallway

  - alias: Turn on upper hallway light at sunset
    trigger:
      - platform: sun
        event: sunset
        offset: '-00:10:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - light.upstairs_hallway
        data:
          brightness: 180

  ###### State based rules #####

  - alias: Set TV to movie mode
    trigger:
      - platform: state
        entity_id: media_player.apple_tv_i_vardagsrum
        state: 'playing'
    condition:
      - condition: template
        value_template: '{{ states.sun.sun.attributes.elevation < 0 }}' #only if sun is down
    action:
      - service: homeassistant.turn_on
        entity_id: 
          - light.living_room_wall
        data: 
          brightness: 50
      - service: homeassistant.turn_off
        entity_id:
          - switch.livingroom_ceiling
      - service: homeassistant.turn_on
        entity_id:
          - light.tv_bench
        data:
          brightness: 77
          rgb_color: [45, 37, 77]



  ######## Mailbox automations #######
  - alias: Turn on mailbox inside light when hatch open
    trigger:
      - platform: state
        entity_id: sensor.mailbox_hatch
        state: 'open'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.mailbox_inside_light
  - alias: Turn off mailbox inside light when hatch closed
    trigger:
      - platform: state
        entity_id: sensor.mailbox_hatch
        state: 'closed'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.mailbox_inside_light
  - alias: Turn on mailbox inside light when door open
    trigger:
      - platform: state
        entity_id: sensor.mailbox_door
        state: 'open'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.mailbox_inside_light
  - alias: Turn off mailbox inside light when door closed
    trigger:
      - platform: state
        entity_id: sensor.mailbox_door
        state: 'closed'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.mailbox_inside_light

  - alias: Turn off mailbox outside light at sunrise
    trigger:
      - platform: sun
    # Possible values: sunset, sunrise
        event: sunrise
    # Optional time offset. This example is 45 minutes.
        offset: '+00:30:00'
    action:
      - service: homeassistant.turn_off
        entity_id:
          - switch.mailbox_outside_light

  - alias: Turn on mailbox outside light at sunset
    trigger:
      - platform: sun
        event: sunset
        offset: '-00:10:00'
    action:
      - service: homeassistant.turn_on
        entity_id:
          - switch.mailbox_outside_light

  - alias: Notify via email and app when hatch open
    trigger:
      - platform: state
        entity_id: sensor.mailbox_hatch
        state: 'open'
    action:
      - service: notify.Mailgun_Notifier
        data:
          title: 'Mailbox Hatch has been opened'
          message: 'Mailbox Hatch has been opened'
      - service: notify.ios_all_your_base_are_belong_to_us_2
        data:
          message: "Alarm set to home mode"

  - alias: Repeat Mailbox statuses every hour
  # This is needed since the MQTT messages seem to time out and then 
  # I'm stuck with unknown statuses. We can't have that! Workaround.
    trigger:
      - platform: time
        # Matches every hour at 27 minutes past whole
        minutes: 27
        seconds: 00
      - platform: time
        # Matches every hour at 27 minutes past whole
        minutes: 57
        seconds: 00
    action:
      - service: mqtt.publish
        data:
         topic: "/outside/mailbox/deposits/"
         payload_template:  "{{ states('sensor.mailbox_deposits') }}"
      - service: mqtt.publish
        data:
         topic: "/outside/mailbox/hatch/"
         payload_template:  "{{ states('sensor.mailbox_hatch') }}"
      - service: mqtt.publish
        data:
         topic: "/outside/mailbox/door/"
         payload_template:  "{{ states('sensor.mailbox_door') }}"


###### Text to speech automations #########

  - alias: 'Test dummy switch'
    trigger:
      - platform: state
        entity_id: switch.dummy_switch
        state: 'on'
    action:
      - service: tts.google_say
        data_template:
          entity_id: media_player.spotify
          message: 'Dummy switch is on'
      - service: tts.google_say
        data_template:
          entity_id: media_player.apple_tv_i_vardagsrum
          message: 'Dummy switch is on'



  #### Renew SSL Cert ####
  - alias: 'Auto Renew SSL Cert'
    trigger:
      platform: numeric_state
      entity_id: sensor.ssl_cert_expiry
      below: 29
    action:
      service: shell_command.renew_ssl
  - alias: 'SSL expiry notification'
    trigger:
      platform: numeric_state
      entity_id: sensor.ssl_cert_expiry
      below: 21
    action:
      service: notify.Mailgun_Notifier
      data:
        title: 'SSL Cert warning'
        message: 'Warning - SSL certificate expires in 21 days and has not been automatically renewed'


